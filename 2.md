1. открыть консоль и зайти по ssh на ВМ

**Консоль 1:** 
```
tsh ssh ***@*** (подключение к VM cloud.tp.wb.ru)
```
2. открыть вторую консоль и также зайти по ssh на ту же ВМ (можно в докере 2 сеанса)

**Консоль 2:** 
```
tsh ssh ***@*** (подключение к VM cloud.tp.wb.ru)
```
3. запустить везде psql из под пользователя postgres

**Консоль 1-2:** 
```
sudo -i -u postgres
postgres@test1:~$ psql
psql (15.8 (Debian 15.8-0+deb12u1))
Введите "help", чтобы получить справку.
```
4. сделать в первой сессии новую таблицу и наполнить ее данными

**Консоль 1:** 
```
    CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    balance BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    INSERT INTO users (name, balance) VALUES
    ('Daniil', 1000),
    ('Ivan', 2000),
    ('Vadim', 3000),
    ('David', 4000);
 ```   
5. посмотреть текущий уровень изоляции

**Консоль 1-2:** 
```
postgres=# SHOW transaction_isolation;
transaction_isolation
−−−−−−−−−−−−−−−−−−−−−−−
read committed
(1 строка)
```
6. начать новую транзакцию в обеих сессиях с дефолтным (не меняя) уровнем
изоляции

**Консоль 1-2:** 
```
BEGIN;
```

7. в первой сессии добавить новую запись

**Консоль 1:** 
```
INSERT INTO users (name, balance) VALUES
    ('Sergei', 5000);
INSERT 0 1
```
8. сделать запрос на выбор всех записей во второй сессии

**Консоль 2:**
```
 SELECT * FROM users WHERE name = 'Sergei';
 id | name | balance | created_at
----+------+---------+------------
(0 строк)
```
9. видите ли вы новую запись и если да то почему? После задания можете сверить
правильный ответ с эталонным (будет доступен после 3 лекции)
```
Не вижу, так как это пример аномалии грязного чтения. Оно допускается только на уровне Read Uncommited, в то время как мы находимся на уровне Read Commited.
```
10. завершить транзакцию в первом окне

**Консоль 1:**
```
postgres=*# COMMIT;
COMMIT
```
11. сделать запрос на выбор всех записей второй сессии

**Консоль 2:**
```
postgres=*# SELECT * FROM users WHERE name = 'Sergei';
 id |  name  | balance |          created_at
----+--------+---------+-------------------------------
  6 | Sergei |    5000 | 2024-10-07 18:29:48.582841+03
(1 строка)
```
12. видите ли вы новую запись и если да то почему?
```
Изменения вижу, это пример аномалии фантомного чтения. Она допускается на уровне Read Commited, на котором мы находимся.
```
13. завершите транзакцию во второй сессии

**Консоль 2**:
```
postgres=*# COMMIT;
COMMIT
```
14. начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях

**Консоль 1-2:**
```
postgres=# BEGIN;
BEGIN
postgres=*# SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET
```
15. в первой сессии добавить новую запись

**Консоль 1:**
```
INSERT INTO users (name, balance) VALUES
    ('Anna', 6000);
INSERT 0 1
```
16. сделать запрос на выбор всех записей во второй сессии

**Консоль 2:** 
```
postgres=*# SELECT * FROM users;
 id |  name  | balance |          created_at
----+--------+---------+-------------------------------
  1 | Daniil |    1000 | 2024-10-07 18:18:32.637041+03
  2 | Ivan   |    2000 | 2024-10-07 18:18:32.637041+03
  3 | Vadim  |    3000 | 2024-10-07 18:18:32.637041+03
  4 | David  |    4000 | 2024-10-07 18:18:32.637041+03
  6 | Sergei |    5000 | 2024-10-07 18:29:48.582841+03
(5 строк)
```
17. видите ли вы новую запись и если да то почему?
```
Не вижу, так как это пример аномалии грязного чтения. Оно допускается только на уровне Read Uncommited, в то время как мы находимся на уровне Repeatable Read.
```
18. завершить транзакцию в первом окне

**Консоль 1:**
```
postgres=*# COMMIT;
COMMIT
```
19. сделать запрос во выбор всех записей второй сессии

**Консоль 2:** 
```
postgres=*# SELECT * FROM users;
 id |  name  | balance |          created_at
----+--------+---------+-------------------------------
  1 | Daniil |    1000 | 2024-10-07 18:18:32.637041+03
  2 | Ivan   |    2000 | 2024-10-07 18:18:32.637041+03
  3 | Vadim  |    3000 | 2024-10-07 18:18:32.637041+03
  4 | David  |    4000 | 2024-10-07 18:18:32.637041+03
  6 | Sergei |    5000 | 2024-10-07 18:29:48.582841+03
(5 строк)
```
20. видите ли вы новую запись и если да то почему?
```
Не вижу, так как это  аномалия фантомного чтения. В стандарте SQL фантомное чтение допускается на уровне Repeatable Read, однако в стандарте PostgreSQL оно не допускается, хотя и не обеспечивает полную изоляцию.
```
